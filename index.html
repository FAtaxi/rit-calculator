<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Welkom bij FA Taxi Centrale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="klant-style.css" />
  <style>
    body {
      background: linear-gradient(135deg, #ffe082 0%, #bfa046 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .welkom-container {
      background: rgba(255,255,255,0.97);
      border-radius: 18px;
      box-shadow: 0 8px 32px #bfa04633, 0 2px 8px #fffbe61a;
      padding: 38px 30px 32px 30px;
      max-width: 420px;
      margin: 48px auto;
      text-align: center;
      border: 2px solid #bfa046;
    }
    h1 {
      color: #bfa046;
      font-size: 2.2em;
      font-weight: 900;
      margin-bottom: 10px;
      letter-spacing: 2px;
      text-shadow: 0 2px 8px #fffbe633;
    }
    .warm {
      color: #a07d1a;
      font-size: 1.18em;
      margin-bottom: 24px;
      font-weight: 600;
      text-shadow: 0 1px 0 #fffbe6;
    }
    label {
      font-size: 1.08em;
      color: #23283a;
      margin-bottom: 4px;
      display: block;
      text-align: left;
      margin-top: 13px;
      font-weight: 500;
      letter-spacing: 0.2px;
    }
    input {
      width: 100%;
      padding: 13px;
      margin: 7px 0 0 0;
      border: 1.5px solid #bfa046;
      border-radius: 8px;
      font-size: 1em;
      color: #23283a;
      background: #fffbe6;
      box-sizing: border-box;
      transition: border 0.2s, background 0.2s;
      font-family: inherit;
    }
    input:focus {
      border: 1.5px solid #2563eb;
      outline: none;
      background: #fff;
    }
    button[type="submit"] {
      background: linear-gradient(90deg, #bfa046, #ffe082);
      color: #23283a;
      font-size: 1.15em;
      padding: 13px 0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      margin-top: 24px;
      font-weight: 700;
      box-shadow: 0 2px 8px #bfa04633;
      transition: background 0.2s, transform 0.1s, color 0.2s;
      letter-spacing: 0.5px;
    }
    button[type="submit"]:hover, button[type="submit"]:focus {
      background: linear-gradient(90deg, #ffe082, #bfa046);
      color: #2563eb;
      transform: translateY(-2px) scale(1.01);
    }
    .error, .success {
      margin-top: 12px;
      font-size: 1em;
      border-radius: 7px;
      padding: 10px 12px;
      display: none;
    }
    .error {
      color: #ff6b6b;
      background: #fff0f0;
      border: 1px solid #ffb3b3;
    }
    .success {
      color: #2ecc40;
      background: #f0fff0;
      border: 1px solid #b3ffb3;
    }
    .verif-container {
      margin-top: 18px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="welkom-container">
    <h1>Welkom bij FA Taxi Centrale</h1>
    <div class="warm">
      Hartelijk welkom! Maak eenvoudig een account aan om snel en veilig een taxi te boeken.<br>
      Wij staan 24/7 voor u klaar met persoonlijke service.
    </div>
    <form id="account-form" autocomplete="off" novalidate>
      <label for="naam">Naam</label>
      <input id="naam" type="text" placeholder="Uw naam" required maxlength="60" />
      <label for="email">E-mail</label>
      <input id="email" type="email" placeholder="Uw e-mailadres" required maxlength="80" />
      <label for="telefoon">Telefoonnummer</label>
      <input id="telefoon" type="tel" placeholder="06-12345678" required maxlength="20" pattern="^0[0-9]{9,10}$" />
      <div class="error" id="form-error"></div>
      <button type="submit">Account aanmaken</button>
    </form>
    <div class="verif-container" id="verif-container">
      <label for="verifcode">Voer de verificatiecode in die u per e-mail heeft ontvangen:</label>
      <input id="verifcode" type="text" maxlength="6" style="text-align:center;font-size:1.2em;letter-spacing:4px;" />
      <button id="verif-btn" style="margin-top:12px;">VerifiÃ«ren</button>
      <div class="error" id="verif-error"></div>
      <div class="success" id="verif-success"></div>
    </div>
  </div>
  <script>
    // Account opslaan in localStorage en verificatiecode via backend/email
    async function sendVerificationEmail(email, code, naam) {
      // Fallback: laat een melding zien als backend niet werkt
      try {
        const resp = await fetch("https://fa-taxi-centrale.onrender.com/api/send-verificatie", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, code, naam })
        });
        if (!resp.ok) throw new Error("Backend gaf een foutmelding");
      } catch (err) {
        alert("Verificatie e-mail kon niet worden verzonden. Controleer of je backend op Render goed draait of probeer het later opnieuw.");
        throw err;
      }
    }

    function saveKlant(klant) {
      // Sla klant op in localStorage (voor demo, in productie: stuur naar backend)
      localStorage.setItem("klant", JSON.stringify(klant));
      // Voeg toe aan klantenlijst voor dashboard, voorkom dubbele e-mail/telefoon
      let klanten = [];
      const klantenStr = localStorage.getItem("klanten");
      if (klantenStr) { try { klanten = JSON.parse(klantenStr); } catch (e) {} }
      klanten = klanten.filter(k =>
        (k.email && klant.email && k.email !== klant.email) &&
        (k.telefoon && klant.telefoon && k.telefoon !== klant.telefoon)
      );
      klanten.push(klant);
      localStorage.setItem("klanten", JSON.stringify(klanten));
    }

    // Check of klant al is ingelogd
    const bestaandeKlant = localStorage.getItem("klant");
    if (bestaandeKlant) {
      window.location.href = "klantpagina.html";
    }

    const form = document.getElementById('account-form');
    const errorDiv = document.getElementById('form-error');
    const verifContainer = document.getElementById('verif-container');
    const verifBtn = document.getElementById('verif-btn');
    const verifError = document.getElementById('verif-error');
    const verifSuccess = document.getElementById('verif-success');
    let gegenereerdeCode = "";

    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      errorDiv.style.display = "none";
      const naam = document.getElementById('naam').value.trim();
      const email = document.getElementById('email').value.trim();
      const telefoon = document.getElementById('telefoon').value.trim();
      if (!naam || !email || !telefoon) {
        errorDiv.innerText = "Vul alle velden in.";
        errorDiv.style.display = "block";
        return;
      }
      // Simpele e-mail en telefoon check
      if (!/^[^@]+@[^@]+\.[^@]+$/.test(email)) {
        errorDiv.innerText = "Voer een geldig e-mailadres in.";
        errorDiv.style.display = "block";
        return;
      }
      if (!/^0[0-9]{9,10}$/.test(telefoon.replace(/\D/g, ""))) {
        errorDiv.innerText = "Voer een geldig Nederlands telefoonnummer in.";
        errorDiv.style.display = "block";
        return;
      }
      // Genereer verificatiecode
      gegenereerdeCode = (Math.floor(100000 + Math.random() * 900000)).toString();
      // Stuur code per e-mail via backend op Render
      try {
        await sendVerificationEmail(email, gegenereerdeCode, naam);
      } catch (err) {
        errorDiv.innerText = "Verificatie e-mail kon niet worden verzonden. Probeer opnieuw.";
        errorDiv.style.display = "block";
        return;
      }
      // Toon verificatieveld
      verifContainer.style.display = "block";
      form.style.display = "none";
      // Sla klant tijdelijk op (nog niet geverifieerd)
      window._nieuweKlant = { naam, email, telefoon, verified: false, aangemaakt: new Date().toISOString(), gps: null };
    });

    verifBtn.addEventListener('click', function(e) {
      e.preventDefault();
      verifError.style.display = "none";
      verifSuccess.style.display = "none";
      const code = document.getElementById('verifcode').value.trim();
      if (code === gegenereerdeCode) {
        // Sla klant definitief op
        const klant = window._nieuweKlant;
        klant.verified = true;
        // GPS ophalen bij registratie
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(pos) {
            klant.gps = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
              tijd: new Date().toISOString()
            };
            saveKlant(klant);
            verifSuccess.innerText = "Account succesvol aangemaakt!";
            verifSuccess.style.display = "block";
            setTimeout(() => { window.location.href = "klantpagina.html"; }, 1200);
          }, function() {
            saveKlant(klant);
            verifSuccess.innerText = "Account succesvol aangemaakt!";
            verifSuccess.style.display = "block";
            setTimeout(() => { window.location.href = "klantpagina.html"; }, 1200);
          });
        } else {
          saveKlant(klant);
          verifSuccess.innerText = "Account succesvol aangemaakt!";
          verifSuccess.style.display = "block";
          setTimeout(() => { window.location.href = "klantpagina.html"; }, 1200);
        }
      } else {
        verifError.innerText = "Verificatiecode is onjuist.";
        verifError.style.display = "block";
      }
    });
  </script>
</body>
</html>
